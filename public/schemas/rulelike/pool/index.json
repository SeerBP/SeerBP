{
  "$schema": "https://json-schema.org/draft/2020-12/schema#",
  "$id": "https://seerbp.github.io/SeerBP/schemas/rulelike/pool",
  "description": "池相关的 JSON Schema 定义",
  "$ref": "#/$defs/PoolObject",
  "$defs": {
    "PoolType": {
      "title": "PoolType",
      "description": "PoolType 表示池的类型",
      "type": "string",
      "enum": [ "NONE", "LIMIT", "POINTS" ]
    },
    "ItemType": {
      "title": "ItemType",
      "description": "ItemType 表示 SubPool 中的物品类型",
      "type": "string",
      "enum": [ "PET", "SUIT", "EQUIPMENT", "TITLE" ]
    },
    "SubPool": {
      "title": "SubPool",
      "description": "SubPool 表示一个子池，完整的池规则是由若干个 SubPool 数组构成的",
      "type": "object",
      "required": [ "contents", "itemType" ],
      "properties": {
        "contents": {
          "title": "contents",
          "description": "子池的内容",
          "type": "array",
          "items": {
            "$ref": "#/$defs/Item"
          }
        },
        "count": {
          "title": "count",
          "description": "对于限制池，这个字段决定了限制数量，对于积分池则是表示内容的积分数量。\n 当池为积分池时，这个字段的值可以是负数，可用于限制过强的物品",
          "type": "integer",
          "format": "int32"
        },
        "itemType": {
          "$ref": "#/$defs/ItemType"
        }
      },
      "additionalProperties": false
    },
    "Item": {
      "title": "Item",
      "description": "Item 表示一个 SubPool 中的内容",
      "type": "object",
      "required": [ "id" ],
      "properties": {
        "id": {
          "title": "id",
          "description": "简单的单 ID 表示，必须为大于 0 的正整数",
          "type": "integer",
          "exclusiveMinimum": 0,
          "format": "int32"
        },
        "endId": {
          "title": "end_id",
          "description": "当该字段存在时，该对象表示一个 ID 范围，范围为 [id, endId]",
          "type": "integer",
          "exclusiveMinimum": 0,
          "format": "int32"
        }
      },
      "additionalProperties": false
    },
    "FallbackCount": {
      "title": "FallbackCount",
      "description": "未在子池中明确列出的物品所使用的默认计数值。在限制模式 (LIMIT) 下表示默认限制数量，在积分模式 (POINTS) 下表示默认积分值。此字段含义与 SubPool 中的 count 字段相同。仅在类型不为 NONE 时生效。",
      "type": "integer",
      "format": "int32"
    },
    "FallbackCounts": {
      "title": "FallbackCounts",
      "description": "按物品类型设置的 fallback 计数值映射。仅在类型不为 NONE 时生效。",
      "type": "object",
      "properties": {
        "PET": {
          "$ref": "#/$defs/FallbackCount"
        },
        "SUIT": {
          "$ref": "#/$defs/FallbackCount"
        },
        "EQUIPMENT": {
          "$ref": "#/$defs/FallbackCount"
        },
        "TITLE": {
          "$ref": "#/$defs/FallbackCount"
        }
      },
      "additionalProperties": false
    },
    "AllowUnlisted": {
      "title": "AllowUnlisted",
      "description": "按物品类型标记该类型的所有物品均可选择（仅受 allowDuplicate 约束）。设置了此标记的类型不得在 pools 中定义对应的子池。仅在类型为 NONE 时生效。",
      "type": "object",
      "properties": {
        "PET": {
          "type": "boolean"
        },
        "SUIT": {
          "type": "boolean"
        },
        "EQUIPMENT": {
          "type": "boolean"
        },
        "TITLE": {
          "type": "boolean"
        }
      },
      "additionalProperties": false
    },
    "PoolObject": {
      "title": "PoolObject",
      "description": "PoolObject 表示一个池规则资源",
      "type": "object",
      "allOf": [
        {
          "if": {
            "required": [ "type" ],
            "properties": {
              "type": {
                "const": "LIMIT"
              }
            }
          },
          "then": {
            "not": {
              "anyOf": [
                {
                  "required": [ "pointsLimit" ]
                },
                {
                  "required": [ "allowUnlisted" ]
                }
              ]
            },
            "properties": {
              "pools": {
                "items": {
                  "required": [ "count" ],
                  "properties": {
                    "count": {
                      "minimum": 0
                    }
                  }
                }
              }
            }
          }
        },
        {
          "if": {
            "required": [ "type" ],
            "properties": {
              "type": {
                "const": "POINTS"
              }
            }
          },
          "then": {
            "not": {
              "required": [ "allowUnlisted" ]
            },
            "required": [ "pointsLimit" ],
            "properties": {
              "pools": {
                "items": {
                  "required": [ "count" ]
                }
              }
            }
          }
        },
        {
          "if": {
            "required": [ "type" ],
            "properties": {
              "type": {
                "const": "NONE"
              }
            }
          },
          "then": {
            "not": {
              "anyOf": [
                {
                  "required": [ "pointsLimit" ]
                },
                {
                  "required": [ "fallbackCounts" ]
                }
              ]
            },
            "properties": {
              "pools": {
                "items": {
                  "not": {
                    "required": [ "count" ]
                  }
                }
              }
            }
          }
        },
        {
          "if": {
            "required": [ "allowUnlisted" ],
            "properties": {
              "allowUnlisted": {
                "required": [ "PET" ],
                "properties": {
                  "PET": {
                    "const": true
                  }
                }
              }
            }
          },
          "then": {
            "properties": {
              "pools": {
                "items": {
                  "not": {
                    "required": [ "itemType" ],
                    "properties": {
                      "itemType": {
                        "const": "PET"
                      }
                    }
                  }
                }
              }
            }
          }
        },
        {
          "if": {
            "required": [ "allowUnlisted" ],
            "properties": {
              "allowUnlisted": {
                "required": [ "SUIT" ],
                "properties": {
                  "SUIT": {
                    "const": true
                  }
                }
              }
            }
          },
          "then": {
            "properties": {
              "pools": {
                "items": {
                  "not": {
                    "required": [ "itemType" ],
                    "properties": {
                      "itemType": {
                        "const": "SUIT"
                      }
                    }
                  }
                }
              }
            }
          }
        },
        {
          "if": {
            "required": [ "allowUnlisted" ],
            "properties": {
              "allowUnlisted": {
                "required": [ "EQUIPMENT" ],
                "properties": {
                  "EQUIPMENT": {
                    "const": true
                  }
                }
              }
            }
          },
          "then": {
            "properties": {
              "pools": {
                "items": {
                  "not": {
                    "required": [ "itemType" ],
                    "properties": {
                      "itemType": {
                        "const": "EQUIPMENT"
                      }
                    }
                  }
                }
              }
            }
          }
        },
        {
          "if": {
            "required": [ "allowUnlisted" ],
            "properties": {
              "allowUnlisted": {
                "required": [ "TITLE" ],
                "properties": {
                  "TITLE": {
                    "const": true
                  }
                }
              }
            }
          },
          "then": {
            "properties": {
              "pools": {
                "items": {
                  "not": {
                    "required": [ "itemType" ],
                    "properties": {
                      "itemType": {
                        "const": "TITLE"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      ],
      "required": [ "metadata", "type", "pools", "allowDuplicate" ],
      "properties": {
        "metadata": {
          "$ref": "https://seerbp.github.io/SeerBP/schemas/rulelike/shared/metadata"
        },
        "pools": {
          "title": "pools",
          "description": "池内容",
          "type": "array",
          "items": {
            "$ref": "#/$defs/SubPool"
          }
        },
        "type": {
          "title": "type",
          "description": "池类型",
          "allOf": [
            {
              "$ref": "#/$defs/PoolType"
            }
          ]
        },
        "pointsLimit": {
          "title": "points_limit",
          "description": "池规则的积分上限，当所选物品积分超过该值时，验证失败。该字段仅在池类型为 POINTS 时生效",
          "type": "integer",
          "format": "int32"
        },
        "allowDuplicate": {
          "title": "allow_duplicate",
          "description": "是否允许选择同一物品多次",
          "type": "boolean"
        },
        "fallbackCounts": {
          "$ref": "#/$defs/FallbackCounts"
        },
        "allowUnlisted": {
          "$ref": "#/$defs/AllowUnlisted"
        }
      },
      "additionalProperties": false
    },
    "https://seerbp.github.io/SeerBP/schemas/rulelike/shared/metadata": {
      "$schema": "https://json-schema.org/draft/2020-12/schema#",
      "$id": "https://seerbp.github.io/SeerBP/schemas/rulelike/shared/metadata",
      "title": "RuleLikeMetadata",
      "description": "规则类资源的元数据。",
      "type": "object",
      "required": [ "id", "name", "description", "author", "sourceUri" ],
      "properties": {
        "id": {
          "$ref": "#/$defs/Id"
        },
        "name": {
          "title": "name",
          "description": "名称",
          "type": "string",
          "maxLength": 16
        },
        "description": {
          "title": "description",
          "description": "介绍，可能为 `CommonMark` 格式",
          "type": "string",
          "maxLength": 100
        },
        "author": {
          "$ref": "#/$defs/Author"
        },
        "tags": {
          "title": "tags",
          "description": "规则标签，用于分类和搜索。",
          "type": "array",
          "maxItems": 5,
          "items": {
            "$ref": "#/$defs/Tag"
          }
        },
        "sourceUri": {
          "title": "source_uri",
          "description": "规则源代码的可访问 URI。",
          "type": "string",
          "format": "uri"
        }
      },
      "$defs": {
        "Id": {
          "title": "id",
          "description": "规则 ID，必须为正整数。",
          "type": "integer",
          "exclusiveMinimum": 0,
          "format": "int32"
        },
        "Author": {
          "title": "author",
          "description": "规则作者信息",
          "type": "object",
          "required": [ "name", "link" ],
          "properties": {
            "name": {
              "title": "name",
              "description": "作者名称",
              "type": "string"
            },
            "link": {
              "title": "link",
              "description": "作者联系方式链接，可以是邮箱、QQ链接，社交媒体主页等。",
              "type": "string"
            }
          }
        },
        "Tag": {
          "title": "tag",
          "description": "规则标签，用于分类和搜索。",
          "type": "string"
        }
      }
    }
  }
}
